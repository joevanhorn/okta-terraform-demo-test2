name: Validate Pull Request

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

permissions:
  contents: read
  pull-requests: write

jobs:
  validate-python:
    name: Validate Python Scripts
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed Python files
        id: changed-python
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...${{ github.sha }} | grep '\.py$' || true)
          else
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep '\.py$' || true)
          fi

          if [ -n "$CHANGED_FILES" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changed Python files:"
            echo "$CHANGED_FILES"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No Python files changed"
          fi

      - name: Set up Python
        if: steps.changed-python.outputs.has_changes == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        if: steps.changed-python.outputs.has_changes == 'true'
        run: |
          python -m pip install --upgrade pip
          pip install flake8 pylint requests

      - name: Lint with flake8
        if: steps.changed-python.outputs.has_changes == 'true'
        run: |
          # Stop the build if there are Python syntax errors or undefined names
          flake8 scripts/ --count --select=E9,F63,F7,F82 --show-source --statistics
          # Exit-zero treats all errors as warnings
          flake8 scripts/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Check Python syntax
        if: steps.changed-python.outputs.has_changes == 'true'
        run: |
          find scripts/ -name "*.py" -exec python -m py_compile {} \;

  validate-yaml:
    name: Validate YAML Files
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PyYAML
        run: pip install pyyaml

      - name: Validate workflow YAML
        run: |
          echo "Validating GitHub workflow files..."
          for file in .github/workflows/*.yml .github/workflows/*.yaml; do
            if [ -f "$file" ]; then
              # Skip files with known YAML parsing issues (heredocs in bash PR bodies)
              if [[ "$file" == *"sync-template.yml" ]] || [[ "$file" == *"import-risk-rules.yml" ]]; then
                echo "Skipping $file (known heredoc parsing issue)"
                continue
              fi
              echo "Checking $file"
              python -c "import yaml; yaml.safe_load(open('$file'))" || exit 1
            fi
          done
          echo "✓ All YAML files are valid"

  validate-markdown:
    name: Validate Documentation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check markdown files
        run: |
          echo "Checking markdown files..."
          # Check that all markdown files are valid and readable
          find . -name "*.md" -type f | while read file; do
            echo "Validating $file"
            cat "$file" > /dev/null || exit 1
          done
          echo "✓ All markdown files are valid"

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for secrets in code
        run: |
          echo "Scanning for potential secrets..."

          # Check for common secret patterns
          if grep -r -i "PRIVATE[_-]KEY" --include="*.tf" --include="*.py" --include="*.yml" . 2>/dev/null; then
            echo "❌ Error: Found potential private key"
            exit 1
          fi

          # Check for hardcoded tokens (excluding template examples)
          if grep -r "OKTA_API_TOKEN.*=" --include="*.tf" --include="*.py" . 2>/dev/null | \
             grep -v "secrets.OKTA_API_TOKEN" | \
             grep -v "OKTA_API_TOKEN}}" | \
             grep -v "environ.get" | \
             grep -v "getenv" | \
             grep -v "# Example" | \
             grep -v "tfvars.example"; then
            echo "❌ Error: Found potentially hardcoded API token"
            exit 1
          fi

          echo "✓ No obvious secrets found"

      - name: Check for sensitive files
        run: |
          echo "Checking for sensitive files..."

          # Check for terraform state files
          if find . -name "terraform.tfstate" -o -name "terraform.tfstate.backup" | grep -q .; then
            echo "❌ Error: Terraform state files should not be committed"
            exit 1
          fi

          # Check for .env files
          if find . -name ".env" -o -name ".env.local" -o -name ".env.*.local" | grep -q .; then
            echo "❌ Error: Environment files should not be committed"
            exit 1
          fi

          # Check for AWS credentials
          if find . -name "credentials" -o -name ".aws" | grep -q .; then
            echo "❌ Error: AWS credentials should not be committed"
            exit 1
          fi

          echo "✓ No sensitive files found"

      - name: Check for large files
        run: |
          echo "Checking for large files (>1MB)..."

          # Find files larger than 1MB (excluding git directory)
          LARGE_FILES=$(find . -type f -size +1M ! -path "./.git/*" ! -path "*/node_modules/*" || true)

          if [ -n "$LARGE_FILES" ]; then
            echo "⚠️  Warning: Large files found:"
            echo "$LARGE_FILES" | while read file; do
              SIZE=$(du -h "$file" | cut -f1)
              echo "  - $file ($SIZE)"
            done
            echo ""
            echo "Consider using Git LFS for large files or exclude them from the repository"
          else
            echo "✓ No large files found"
          fi

  validate-structure:
    name: Validate Repository Structure
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate directory structure
        run: |
          echo "Validating repository structure..."

          # Check for required directories
          required_dirs=("docs" "scripts" "environments" ".github/workflows")
          for dir in "${required_dirs[@]}"; do
            if [ ! -d "$dir" ]; then
              echo "❌ Error: Required directory missing: $dir"
              exit 1
            fi
          done

          echo "✓ Repository structure is valid"

      - name: Check script permissions
        run: |
          echo "Checking Python script permissions..."

          # Find Python scripts and check if they're executable
          find scripts/ -name "*.py" -type f | while read file; do
            if [ ! -x "$file" ]; then
              echo "ℹ️  Script not executable: $file"
            fi
          done

          echo "✓ Script permissions checked"

  validate-terraform-fmt:
    name: Terraform Format Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed Terraform files
        id: changed-tf
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...${{ github.sha }} | grep '\.tf$' || true)
          else
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep '\.tf$' || true)
          fi

          if [ -n "$CHANGED_FILES" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changed Terraform files:"
            echo "$CHANGED_FILES"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No Terraform files changed"
          fi

      - name: Setup Terraform
        if: steps.changed-tf.outputs.has_changes == 'true'
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.9.0"

      - name: Terraform Format Check
        if: steps.changed-tf.outputs.has_changes == 'true'
        run: |
          echo "Checking Terraform formatting..."
          terraform fmt -check -recursive || {
            echo "❌ Error: Terraform files are not formatted correctly"
            echo "Run 'terraform fmt -recursive' to fix"
            exit 1
          }
          echo "✓ Terraform files are properly formatted"

  summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [validate-yaml, security-scan, validate-structure]
    if: always()

    steps:
      - name: Check validation results
        run: |
          echo "## Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| YAML Validation | ${{ needs.validate-yaml.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Structure Validation | ${{ needs.validate-structure.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.validate-yaml.result }}" != "success" ] || \
             [ "${{ needs.security-scan.result }}" != "success" ] || \
             [ "${{ needs.validate-structure.result }}" != "success" ]; then
            echo "❌ Some validations failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "✅ All validations passed!" >> $GITHUB_STEP_SUMMARY
