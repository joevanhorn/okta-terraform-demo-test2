name: Import All Resources from Okta

on:
  workflow_dispatch:
    inputs:
      tenant_environment:
        description: 'Environment name (must match directory in environments/)'
        required: true
        type: string
        default: 'myorg'
      update_terraform:
        description: 'Update production-ready Terraform files'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      commit_changes:
        description: 'Commit and push changes to repository'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  import-all:
    name: Import All Resources from Tenant
    runs-on: ubuntu-latest

    environment:
      name: ${{ inputs.tenant_environment }}

    permissions:
      contents: write
      pull-requests: write  # Required for creating PR
      actions: read
      id-token: write  # Required for AWS OIDC authentication

    steps:
      - name: Workflow Overview
        run: |
          echo "=================================================================="
          echo "  COMPLETE TENANT IMPORT - ALL RESOURCES"
          echo "=================================================================="
          echo ""
          echo "Environment: ${{ inputs.tenant_environment }}"
          echo "Update Terraform: ${{ inputs.update_terraform }}"
          echo "Commit Changes: ${{ inputs.commit_changes }}"
          echo ""
          echo "This workflow will import:"
          echo "  1. OIG Entitlement Bundles ‚Üí Terraform (okta_entitlement_bundle)"
          echo "  2. OIG Access Reviews ‚Üí Terraform (okta_reviews)"
          echo "  3. OIG Approval Workflows ‚Üí Terraform (okta_request_sequences)"
          echo "  4. OIG Catalog Entries ‚Üí Terraform (okta_catalog_entry_default)"
          echo "  5. OIG Request Settings ‚Üí Terraform (okta_request_settings)"
          echo "  6. Resource Owners ‚Üí config/owner_mappings.json"
          echo "  7. Governance Labels ‚Üí config/label_mappings.json"
          echo "  8. Risk Rules (SOD Policies) ‚Üí config/risk_rules.json"
          echo ""
          echo "NOTE: Principal assignments (grants) are NOT imported and should"
          echo "be managed in Okta Admin UI or via direct API calls."
          echo "=================================================================="

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Environment Exists
        run: |
          if [ ! -d "environments/${{ inputs.tenant_environment }}" ]; then
            echo "‚ùå Environment not found: ${{ inputs.tenant_environment }}"
            echo "Available environments:"
            ls -1 environments/ | grep -v README.md
            exit 1
          fi
          echo "‚úÖ Environment found: ${{ inputs.tenant_environment }}"

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Set up environment variables
        env:
          OKTA_API_TOKEN: ${{ secrets.OKTA_API_TOKEN }}
          OKTA_ORG_NAME: ${{ secrets.OKTA_ORG_NAME }}
          OKTA_BASE_URL: ${{ secrets.OKTA_BASE_URL }}
        run: |
          echo "OKTA_ORG_NAME=${OKTA_ORG_NAME}" >> $GITHUB_ENV
          echo "OKTA_BASE_URL=${OKTA_BASE_URL}" >> $GITHUB_ENV
          echo "OKTA_API_TOKEN=${OKTA_API_TOKEN}" >> $GITHUB_ENV
          echo "Configured for org: ${OKTA_ORG_NAME}"

      - name: Verify API access
        run: |
          echo "Testing API access..."
          RESPONSE=$(curl -s -w "%{http_code}" -H "Authorization: SSWS ${OKTA_API_TOKEN}" -H "Accept: application/json" "https://${OKTA_ORG_NAME}.${OKTA_BASE_URL}/api/v1/users?limit=1")
          HTTP_CODE="${RESPONSE: -3}"
          if [ "$HTTP_CODE" != "200" ]; then
            echo "‚ùå API authentication failed"
            exit 1
          fi
          echo "‚úÖ API access confirmed"

      - name: Create import directories
        run: |
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          ENV_NAME=$(echo "${{ inputs.tenant_environment }}" | tr '[:upper:]' '[:lower:]')

          echo "TIMESTAMP=${TIMESTAMP}" >> $GITHUB_ENV
          echo "ENV_NAME=${ENV_NAME}" >> $GITHUB_ENV
          echo "ENV_DIR=environments/${ENV_NAME}" >> $GITHUB_ENV
          echo "IMPORT_DIR=complete-import-${TIMESTAMP}" >> $GITHUB_ENV

          # Create temporary import directory
          mkdir -p complete-import-${TIMESTAMP}/oig-resources
          mkdir -p complete-import-${TIMESTAMP}/config-exports

          # Create environment-specific directories
          mkdir -p environments/${ENV_NAME}/{terraform,imports,config}

          echo "Environment directory: environments/${ENV_NAME}"

      # ============================================================================
      # STEP 1: Import OIG Resources to Terraform
      # ============================================================================

      - name: "Step 1: Import OIG Resources to Terraform"
        id: import_oig
        run: |
          echo ""
          echo "=================================================================="
          echo "STEP 1: Importing OIG Resources to Terraform"
          echo "=================================================================="
          chmod +x scripts/import_oig_resources.py

          python3 scripts/import_oig_resources.py \
            --output-dir "${{ env.IMPORT_DIR }}/oig-resources" 2>&1 | tee import_oig.log

          IMPORT_STATUS=$?
          echo "import_status=$IMPORT_STATUS" >> $GITHUB_OUTPUT

          # Count imported resources
          if [ -f "${{ env.IMPORT_DIR }}/oig-resources/entitlements.json" ]; then
            BUNDLES=$(jq '.entitlements | length' "${{ env.IMPORT_DIR }}/oig-resources/entitlements.json" 2>/dev/null || echo "0")
          else
            BUNDLES=0
          fi

          if [ -f "${{ env.IMPORT_DIR }}/oig-resources/reviews.json" ]; then
            REVIEWS=$(jq '.reviews | length' "${{ env.IMPORT_DIR }}/oig-resources/reviews.json" 2>/dev/null || echo "0")
          else
            REVIEWS=0
          fi

          if [ -f "${{ env.IMPORT_DIR }}/oig-resources/request_sequences.json" ]; then
            SEQUENCES=$(jq '.sequences | length' "${{ env.IMPORT_DIR }}/oig-resources/request_sequences.json" 2>/dev/null || echo "0")
          else
            SEQUENCES=0
          fi

          echo "bundles_count=$BUNDLES" >> $GITHUB_OUTPUT
          echo "reviews_count=$REVIEWS" >> $GITHUB_OUTPUT
          echo "sequences_count=$SEQUENCES" >> $GITHUB_OUTPUT

          echo "‚úÖ Imported $BUNDLES entitlement bundles"
          echo "‚úÖ Imported $REVIEWS access reviews"
          echo "‚úÖ Imported $SEQUENCES approval workflows"

      # ============================================================================
      # STEP 2: Sync Resource Owners
      # ============================================================================

      - name: "Step 2: Sync Resource Owners"
        id: sync_owners
        run: |
          echo ""
          echo "=================================================================="
          echo "STEP 2: Syncing Resource Owners from Okta"
          echo "=================================================================="
          chmod +x scripts/sync_owner_mappings.py

          python3 scripts/sync_owner_mappings.py \
            --output "${{ env.IMPORT_DIR }}/config-exports/owner_mappings.json" 2>&1 | tee sync_owners.log

          SYNC_STATUS=$?
          echo "sync_status=$SYNC_STATUS" >> $GITHUB_OUTPUT

          # Count owners
          if [ -f "${{ env.IMPORT_DIR }}/config-exports/owner_mappings.json" ]; then
            TOTAL_OWNERS=0
            for key in apps groups entitlement_bundles; do
              COUNT=$(jq ".${key} | length" "${{ env.IMPORT_DIR }}/config-exports/owner_mappings.json" 2>/dev/null || echo "0")
              TOTAL_OWNERS=$((TOTAL_OWNERS + COUNT))
            done
            echo "owners_count=$TOTAL_OWNERS" >> $GITHUB_OUTPUT
            echo "‚úÖ Synced $TOTAL_OWNERS resource owner mappings"
          else
            echo "owners_count=0" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  No resource owners found"
          fi

      # ============================================================================
      # STEP 3: Sync Governance Labels
      # ============================================================================

      - name: "Step 3: Sync Governance Labels"
        id: sync_labels
        run: |
          echo ""
          echo "=================================================================="
          echo "STEP 3: Syncing Governance Labels from Okta"
          echo "=================================================================="
          chmod +x scripts/sync_label_mappings.py

          python3 scripts/sync_label_mappings.py \
            --output "${{ env.IMPORT_DIR }}/config-exports/label_mappings.json" 2>&1 | tee sync_labels.log

          SYNC_STATUS=$?
          echo "sync_status=$SYNC_STATUS" >> $GITHUB_OUTPUT

          # Count labels and assignments
          if [ -f "${{ env.IMPORT_DIR }}/config-exports/label_mappings.json" ]; then
            LABELS=$(jq '.labels | length' "${{ env.IMPORT_DIR }}/config-exports/label_mappings.json" 2>/dev/null || echo "0")
            echo "labels_count=$LABELS" >> $GITHUB_OUTPUT
            echo "‚úÖ Synced $LABELS governance labels"
          else
            echo "labels_count=0" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  No governance labels found"
          fi

      # ============================================================================
      # STEP 4: Import Risk Rules (SOD Policies)
      # ============================================================================

      - name: "Step 4: Import Risk Rules"
        id: import_risk_rules
        run: |
          echo ""
          echo "=================================================================="
          echo "STEP 4: Importing Risk Rules (SOD Policies) from Okta"
          echo "=================================================================="
          chmod +x scripts/import_risk_rules.py

          python3 scripts/import_risk_rules.py \
            --output "${{ env.IMPORT_DIR }}/config-exports/risk_rules.json" 2>&1 | tee import_risk_rules.log

          IMPORT_STATUS=$?
          echo "import_status=$IMPORT_STATUS" >> $GITHUB_OUTPUT

          # Count risk rules
          if [ -f "${{ env.IMPORT_DIR }}/config-exports/risk_rules.json" ]; then
            RULES=$(jq '.rules | length' "${{ env.IMPORT_DIR }}/config-exports/risk_rules.json" 2>/dev/null || echo "0")
            echo "rules_count=$RULES" >> $GITHUB_OUTPUT
            echo "‚úÖ Imported $RULES risk rules"
          else
            echo "rules_count=0" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  No risk rules found"
          fi

      # ============================================================================
      # STEP 5: Update Terraform Files (if requested)
      # ============================================================================

      - name: "Step 5: Update Terraform Files"
        if: inputs.update_terraform == 'true'
        run: |
          echo ""
          echo "=================================================================="
          echo "STEP 5: Updating Environment Terraform Files"
          echo "=================================================================="
          echo "Target: ${{ env.ENV_DIR }}/terraform/"

          # Backup existing files
          if [ -f "${{ env.ENV_DIR }}/terraform/oig_entitlements.tf" ]; then
            cp "${{ env.ENV_DIR }}/terraform/oig_entitlements.tf" "${{ env.ENV_DIR }}/terraform/oig_entitlements.tf.backup-${{ env.TIMESTAMP }}"
            echo "üì¶ Backed up existing oig_entitlements.tf"
          fi

          if [ -f "${{ env.ENV_DIR }}/terraform/oig_reviews.tf" ]; then
            cp "${{ env.ENV_DIR }}/terraform/oig_reviews.tf" "${{ env.ENV_DIR }}/terraform/oig_reviews.tf.backup-${{ env.TIMESTAMP }}"
            echo "üì¶ Backed up existing oig_reviews.tf"
          fi

          # Copy new Terraform files to environment directory
          if [ -f "${{ env.IMPORT_DIR }}/oig-resources/entitlements.tf" ]; then
            cp "${{ env.IMPORT_DIR }}/oig-resources/entitlements.tf" "${{ env.ENV_DIR }}/terraform/oig_entitlements.tf"
            echo "‚úÖ Updated ${{ env.ENV_DIR }}/terraform/oig_entitlements.tf"
          fi

          if [ -f "${{ env.IMPORT_DIR }}/oig-resources/reviews.tf" ]; then
            cp "${{ env.IMPORT_DIR }}/oig-resources/reviews.tf" "${{ env.ENV_DIR }}/terraform/oig_reviews.tf"
            echo "‚úÖ Updated ${{ env.ENV_DIR }}/terraform/oig_reviews.tf"
          fi

          if [ -f "${{ env.IMPORT_DIR }}/oig-resources/request_sequences.tf" ]; then
            cp "${{ env.IMPORT_DIR }}/oig-resources/request_sequences.tf" "${{ env.ENV_DIR }}/terraform/oig_request_sequences.tf"
            echo "‚úÖ Updated ${{ env.ENV_DIR }}/terraform/oig_request_sequences.tf"
          fi

          if [ -f "${{ env.IMPORT_DIR }}/oig-resources/catalog_entries.tf" ]; then
            cp "${{ env.IMPORT_DIR }}/oig-resources/catalog_entries.tf" "${{ env.ENV_DIR }}/terraform/oig_catalog_entries.tf"
            echo "‚úÖ Updated ${{ env.ENV_DIR }}/terraform/oig_catalog_entries.tf"
          fi

          if [ -f "${{ env.IMPORT_DIR }}/oig-resources/request_settings.tf" ]; then
            cp "${{ env.IMPORT_DIR }}/oig-resources/request_settings.tf" "${{ env.ENV_DIR }}/terraform/oig_request_settings.tf"
            echo "‚úÖ Updated ${{ env.ENV_DIR }}/terraform/oig_request_settings.tf"
          fi

          # Copy JSON reference files to imports directory
          cp "${{ env.IMPORT_DIR }}/oig-resources/"*.json "${{ env.ENV_DIR }}/imports/" 2>/dev/null || true
          echo "‚úÖ Updated JSON reference files in ${{ env.ENV_DIR }}/imports/"

      # ============================================================================
      # STEP 6: Import Resources into Terraform State
      # ============================================================================

      - name: "Step 6: Configure AWS Credentials for Terraform"
        if: inputs.update_terraform == 'true'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-ImportResources-${{ inputs.tenant_environment }}
          aws-region: us-east-1

      - name: "Step 6: Setup Terraform"
        if: inputs.update_terraform == 'true'
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.0

      - name: "Step 6: Import Resources into Terraform State"
        if: inputs.update_terraform == 'true'
        working-directory: ${{ env.ENV_DIR }}/terraform
        env:
          TF_VAR_okta_org_name: ${{ secrets.OKTA_ORG_NAME }}
          TF_VAR_okta_base_url: ${{ secrets.OKTA_BASE_URL }}
          TF_VAR_okta_api_token: ${{ secrets.OKTA_API_TOKEN }}
        run: |
          echo ""
          echo "=================================================================="
          echo "STEP 6: Importing Resources into Terraform State"
          echo "=================================================================="

          # Check if import script exists
          if [ ! -f "${{ github.workspace }}/${{ env.IMPORT_DIR }}/oig-resources/import.sh" ]; then
            echo "‚ö†Ô∏è  No import script found - skipping state import"
            echo "   (This is normal if no OIG resources were imported)"
            exit 0
          fi

          # Create terraform.tfvars
          cat > terraform.tfvars << EOF
          okta_org_name  = "${{ secrets.OKTA_ORG_NAME }}"
          okta_base_url  = "${{ secrets.OKTA_BASE_URL }}"
          okta_api_token = "${{ secrets.OKTA_API_TOKEN }}"
          EOF

          echo "üîß Initializing Terraform with S3 backend..."
          terraform init

          echo ""
          echo "üßπ Cleaning up old entitlement bundle resources from state..."
          echo "   This ensures idempotent imports by removing stale bundle definitions."

          # List all entitlement bundle resources in state
          OLD_BUNDLES=$(terraform state list | grep "okta_entitlement_bundle" || true)

          if [ -n "$OLD_BUNDLES" ]; then
            echo "   Found $(echo "$OLD_BUNDLES" | wc -l) existing entitlement bundles in state"

            # Remove each old bundle from state
            while IFS= read -r bundle; do
              if [ -n "$bundle" ]; then
                echo "   Removing: $bundle"
                terraform state rm "$bundle" || echo "   (Already removed or not found)"
              fi
            done <<< "$OLD_BUNDLES"

            echo "‚úÖ State cleanup complete"
          else
            echo "   No existing entitlement bundles found in state (clean slate)"
          fi

          echo ""
          echo "üì• Importing resources into Terraform state..."
          echo "   This tells Terraform that these resources already exist in Okta."
          echo ""

          # Copy import script to working directory
          cp "${{ github.workspace }}/${{ env.IMPORT_DIR }}/oig-resources/import.sh" ./import.sh
          chmod +x ./import.sh

          # Run import script (continue on errors for idempotency)
          set +e
          ./import.sh 2>&1 | tee import_execution.log
          IMPORT_EXIT_CODE=$?
          set -e

          # Count successful imports
          SUCCESSFUL_IMPORTS=$(grep -c "Import successful" import_execution.log || echo "0")
          ALREADY_MANAGED=$(grep -c "already being managed" import_execution.log || echo "0")
          TOTAL_IMPORTS=$((SUCCESSFUL_IMPORTS + ALREADY_MANAGED))

          echo ""
          echo "‚úÖ Import complete!"
          echo "   - Successfully imported: $SUCCESSFUL_IMPORTS resources"
          echo "   - Already managed: $ALREADY_MANAGED resources"
          echo "   - Total in state: $TOTAL_IMPORTS resources"
          echo ""

          # Clean up sensitive files
          rm -f terraform.tfvars

          # Verify state
          echo "üîç Verifying Terraform state..."
          terraform state list | head -20
          RESOURCE_COUNT=$(terraform state list | wc -l)
          echo ""
          echo "‚úÖ Terraform state now contains $RESOURCE_COUNT resources"

      # ============================================================================
      # STEP 7: Update Config Files
      # ============================================================================

      - name: "Step 7: Update Config Files"
        run: |
          echo ""
          echo "=================================================================="
          echo "STEP 7: Updating Environment Config Files"
          echo "=================================================================="
          echo "Target: ${{ env.ENV_DIR }}/config/"

          # Backup existing config files
          if [ -f "${{ env.ENV_DIR }}/config/owner_mappings.json" ]; then
            cp "${{ env.ENV_DIR }}/config/owner_mappings.json" "${{ env.ENV_DIR }}/config/owner_mappings.json.backup-${{ env.TIMESTAMP }}"
            echo "üì¶ Backed up existing owner_mappings.json"
          fi

          if [ -f "${{ env.ENV_DIR }}/config/label_mappings.json" ]; then
            cp "${{ env.ENV_DIR }}/config/label_mappings.json" "${{ env.ENV_DIR }}/config/label_mappings.json.backup-${{ env.TIMESTAMP }}"
            echo "üì¶ Backed up existing label_mappings.json"
          fi

          if [ -f "${{ env.ENV_DIR }}/config/risk_rules.json" ]; then
            cp "${{ env.ENV_DIR }}/config/risk_rules.json" "${{ env.ENV_DIR }}/config/risk_rules.json.backup-${{ env.TIMESTAMP }}"
            echo "üì¶ Backed up existing risk_rules.json"
          fi

          # Copy new config files to environment directory
          if [ -f "${{ env.IMPORT_DIR }}/config-exports/owner_mappings.json" ]; then
            cp "${{ env.IMPORT_DIR }}/config-exports/owner_mappings.json" "${{ env.ENV_DIR }}/config/owner_mappings.json"
            echo "‚úÖ Updated ${{ env.ENV_DIR }}/config/owner_mappings.json"
          fi

          if [ -f "${{ env.IMPORT_DIR }}/config-exports/label_mappings.json" ]; then
            cp "${{ env.IMPORT_DIR }}/config-exports/label_mappings.json" "${{ env.ENV_DIR }}/config/label_mappings.json"
            echo "‚úÖ Updated ${{ env.ENV_DIR }}/config/label_mappings.json"
          fi

          if [ -f "${{ env.IMPORT_DIR }}/config-exports/risk_rules.json" ]; then
            cp "${{ env.IMPORT_DIR }}/config-exports/risk_rules.json" "${{ env.ENV_DIR }}/config/risk_rules.json"
            echo "‚úÖ Updated ${{ env.ENV_DIR }}/config/risk_rules.json"
          fi

      # ============================================================================
      # STEP 8: Upload Artifacts
      # ============================================================================

      - name: "Step 8: Upload Import Artifacts"
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: complete-import-${{ inputs.tenant_environment }}-${{ env.TIMESTAMP }}
          path: |
            ${{ env.IMPORT_DIR }}/
            *.log
          retention-days: 180

      # ============================================================================
      # STEP 9: Create Pull Request with Changes (if requested)
      # ============================================================================

      - name: "Step 9: Create Pull Request with Changes"
        if: inputs.commit_changes == 'true' && success()
        run: |
          echo ""
          echo "=================================================================="
          echo "STEP 9: Creating Pull Request with Changes"
          echo "=================================================================="

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Stage all changes in environment directory
          git add ${{ env.ENV_DIR }}/terraform/*.tf 2>/dev/null || true
          git add ${{ env.ENV_DIR }}/imports/*.json 2>/dev/null || true
          git add ${{ env.ENV_DIR }}/config/*.json 2>/dev/null || true
          git add environments/README.md 2>/dev/null || true
          git add ${{ env.ENV_DIR }}/README.md 2>/dev/null || true

          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è  No changes to commit - PR creation skipped"
          else
            # Create branch for changes
            BRANCH_NAME="import/all-resources-${{ inputs.tenant_environment }}-${{ env.TIMESTAMP }}"
            git checkout -b "$BRANCH_NAME"

            # Commit changes
            git commit -m "$(cat <<'EOF'
          feat(import): Complete import from ${{ inputs.tenant_environment }} tenant

          Imported all supported resources to ${{ env.ENV_DIR }}/:
          - Entitlement bundles: ${{ steps.import_oig.outputs.bundles_count }}
          - Access reviews: ${{ steps.import_oig.outputs.reviews_count }}
          - Approval workflows: ${{ steps.import_oig.outputs.sequences_count }}
          - Resource owners: ${{ steps.sync_owners.outputs.owners_count }}
          - Governance labels: ${{ steps.sync_labels.outputs.labels_count }}
          - Risk rules: ${{ steps.import_risk_rules.outputs.rules_count }}

          Files updated:
          - ${{ env.ENV_DIR }}/terraform/ (Terraform configurations)
          - ${{ env.ENV_DIR }}/imports/ (Raw API import data)
          - ${{ env.ENV_DIR }}/config/ (Resource owners, labels, and risk rules)

          NOTE: Principal assignments (grants) are managed in Okta UI, not in code.

          ü§ñ Auto-generated by workflow

          EOF
          )"

            # Push branch
            git push -u origin "$BRANCH_NAME"

            # Create pull request
            gh pr create \
              --title "Import all resources from ${{ inputs.tenant_environment }}" \
              --body "$(cat <<'EOF'
          ## Import Summary

          **Environment:** ${{ inputs.tenant_environment }}
          **Timestamp:** ${{ env.TIMESTAMP }}
          **Org:** ${OKTA_ORG_NAME}.${OKTA_BASE_URL}

          ### Resources Imported

          | Resource Type | Count |
          |---------------|-------|
          | Entitlement Bundles | ${{ steps.import_oig.outputs.bundles_count }} |
          | Access Reviews | ${{ steps.import_oig.outputs.reviews_count }} |
          | Approval Workflows | ${{ steps.import_oig.outputs.sequences_count }} |
          | Resource Owners | ${{ steps.sync_owners.outputs.owners_count }} |
          | Governance Labels | ${{ steps.sync_labels.outputs.labels_count }} |
          | Risk Rules | ${{ steps.import_risk_rules.outputs.rules_count }} |

          ### Files Updated

          - `${{ env.ENV_DIR }}/terraform/*.tf` - Terraform configurations
          - `${{ env.ENV_DIR }}/imports/*.json` - Raw API import data
          - `${{ env.ENV_DIR }}/config/*.json` - Resource owners, labels, and risk rules

          ### Next Steps

          1. Review the imported Terraform configurations
          2. Complete any TODO items in generated .tf files
          3. Review config files for accuracy
          4. After merge, run `terraform plan` to verify state

          ### Important Notes

          - üìù **Entitlement bundle definitions** are now managed in Terraform
          - ‚ö†Ô∏è  **Principal assignments (grants)** should be managed in Okta Admin UI
          - üîß **Resource owners** can be applied using the Apply Owners workflow
          - üè∑Ô∏è  **Governance labels** can be applied using the Apply Labels workflow
          - üõ°Ô∏è  **Risk rules** can be applied using the Apply Risk Rules workflow

          ü§ñ Auto-generated by [Import All Resources workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          EOF
          )" \
              --base main \
              --head "$BRANCH_NAME"

            echo "‚úÖ Pull request created successfully"
            echo "Branch: $BRANCH_NAME"
          fi

      # ============================================================================
      # STEP 10: Generate Summary Report
      # ============================================================================

      - name: "Step 10: Generate Summary Report"
        if: always()
        run: |
          echo "# Complete Tenant Import Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.tenant_environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** ${{ env.TIMESTAMP }}" >> $GITHUB_STEP_SUMMARY
          echo "**Org:** ${OKTA_ORG_NAME}.${OKTA_BASE_URL}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Resources Imported" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Resource Type | Count | Destination |" >> $GITHUB_STEP_SUMMARY
          echo "|---------------|-------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Entitlement Bundles | ${{ steps.import_oig.outputs.bundles_count }} | ${{ env.ENV_DIR }}/terraform/oig_entitlements.tf |" >> $GITHUB_STEP_SUMMARY
          echo "| Access Reviews | ${{ steps.import_oig.outputs.reviews_count }} | ${{ env.ENV_DIR }}/terraform/oig_reviews.tf |" >> $GITHUB_STEP_SUMMARY
          echo "| Approval Workflows | ${{ steps.import_oig.outputs.sequences_count }} | ${{ env.ENV_DIR }}/terraform/oig_request_sequences.tf |" >> $GITHUB_STEP_SUMMARY
          echo "| Resource Owners | ${{ steps.sync_owners.outputs.owners_count }} | ${{ env.ENV_DIR }}/config/owner_mappings.json |" >> $GITHUB_STEP_SUMMARY
          echo "| Governance Labels | ${{ steps.sync_labels.outputs.labels_count }} | ${{ env.ENV_DIR }}/config/label_mappings.json |" >> $GITHUB_STEP_SUMMARY
          echo "| Risk Rules | ${{ steps.import_risk_rules.outputs.rules_count }} | ${{ env.ENV_DIR }}/config/risk_rules.json |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Actions Taken" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.update_terraform }}" == "true" ]; then
            echo "- ‚úÖ Terraform files updated in ${{ env.ENV_DIR }}/terraform/" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ‚ÑπÔ∏è  Terraform files NOT updated (update_terraform=false)" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ inputs.commit_changes }}" == "true" ]; then
            echo "- ‚úÖ Pull request created with imported resources" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ‚ÑπÔ∏è  Changes NOT committed (commit_changes=false)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.commit_changes }}" == "true" ]; then
            echo "1. **Review the pull request** created by this workflow" >> $GITHUB_STEP_SUMMARY
            echo "2. **Review imported Terraform configurations** in the PR diff" >> $GITHUB_STEP_SUMMARY
            echo "3. **Complete TODO items** in generated .tf files" >> $GITHUB_STEP_SUMMARY
            echo "4. **Merge the pull request** after review and approval" >> $GITHUB_STEP_SUMMARY
            echo "5. **Initialize and plan Terraform** after merge:" >> $GITHUB_STEP_SUMMARY
          else
            echo "1. **Review imported Terraform configurations** in ${{ env.ENV_DIR }}/terraform/" >> $GITHUB_STEP_SUMMARY
            echo "2. **Complete TODO items** in generated .tf files" >> $GITHUB_STEP_SUMMARY
            echo "3. **Review config files** in ${{ env.ENV_DIR }}/config/" >> $GITHUB_STEP_SUMMARY
            echo "4. **Initialize and plan Terraform:**" >> $GITHUB_STEP_SUMMARY
          fi
          echo "   \`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "   cd ${{ env.ENV_DIR }}/terraform" >> $GITHUB_STEP_SUMMARY
          echo "   terraform init" >> $GITHUB_STEP_SUMMARY
          echo "   terraform plan" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Important Notes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- üìù **Entitlement bundle definitions** are now managed in Terraform" >> $GITHUB_STEP_SUMMARY
          echo "- ‚ö†Ô∏è  **Principal assignments (grants)** should be managed in Okta Admin UI" >> $GITHUB_STEP_SUMMARY
          echo "- üîß **Resource owners** can be applied using the Apply Owners workflow" >> $GITHUB_STEP_SUMMARY
          echo "- üè∑Ô∏è  **Governance labels** can be applied using the Apply Labels workflow" >> $GITHUB_STEP_SUMMARY
          echo "- üõ°Ô∏è  **Risk rules** can be applied using the Apply Risk Rules workflow" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üì• Download artifacts to review complete import data and logs" >> $GITHUB_STEP_SUMMARY
