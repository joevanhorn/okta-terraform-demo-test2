name: Apply Risk Rules

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - myorg
          - production
          - staging
          - development
      dry_run:
        description: 'Dry run mode (show what would change without applying)'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      delete_removed:
        description: 'Delete risk rules that exist in Okta but not in config'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  apply-risk-rules:
    name: Apply Risk Rules to Okta
    runs-on: ubuntu-latest

    environment: ${{ inputs.environment }}

    permissions:
      contents: write
      actions: read

    steps:
      - name: Workflow Overview
        run: |
          echo "=================================================="
          echo "  APPLY RISK RULES TO OKTA"
          echo "=================================================="
          echo ""
          echo "Environment: ${{ inputs.environment }}"
          echo "Operation: Apply risk rules (SOD policies) from config"
          echo "Dry Run: ${{ github.event.inputs.dry_run }}"
          echo "Delete Removed: ${{ github.event.inputs.delete_removed }}"
          echo "=================================================="

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Set up environment variables
        env:
          OKTA_API_TOKEN: ${{ secrets.OKTA_API_TOKEN }}
          OKTA_ORG_NAME: ${{ secrets.OKTA_ORG_NAME }}
          OKTA_BASE_URL: ${{ secrets.OKTA_BASE_URL }}
        run: |
          echo "OKTA_ORG_NAME=${OKTA_ORG_NAME}" >> $GITHUB_ENV
          echo "OKTA_BASE_URL=${OKTA_BASE_URL}" >> $GITHUB_ENV
          echo "OKTA_API_TOKEN=${OKTA_API_TOKEN}" >> $GITHUB_ENV

      - name: Check risk rules config file
        run: |
          CONFIG_FILE="environments/${{ inputs.environment }}/config/risk_rules.json"

          if [ ! -f "$CONFIG_FILE" ]; then
            echo "âŒ risk_rules.json not found at $CONFIG_FILE"
            echo "Run 'gh workflow run import-risk-rules.yml -f environment=${{ inputs.environment }}' to create it"
            exit 1
          fi

          echo "âœ… Found risk_rules.json"
          echo ""
          echo "Preview of risk rules:"
          jq '.rules | length' "$CONFIG_FILE" | xargs -I {} echo "  Total rules in config: {}"
          jq '.rules[] | .name' "$CONFIG_FILE" | head -10

      - name: Apply risk rules
        id: apply
        run: |
          chmod +x scripts/apply_risk_rules.py

          CONFIG_FILE="environments/${{ inputs.environment }}/config/risk_rules.json"
          ARGS="--config $CONFIG_FILE"

          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            echo "Running in DRY RUN mode..."
            ARGS="$ARGS --dry-run"
          else
            echo "Running in APPLY mode..."
          fi

          if [ "${{ github.event.inputs.delete_removed }}" == "true" ]; then
            echo "Will delete rules not in config..."
            ARGS="$ARGS --delete-removed"
          fi

          python3 scripts/apply_risk_rules.py $ARGS 2>&1 | tee apply.log

          APPLY_STATUS=$?
          echo "apply_status=$APPLY_STATUS" >> $GITHUB_OUTPUT

      - name: Parse results
        id: results
        run: |
          # Count rules from config
          CONFIG_FILE="environments/${{ inputs.environment }}/config/risk_rules.json"
          TOTAL=$(jq '.rules | length' "$CONFIG_FILE")

          echo "total=$TOTAL" >> $GITHUB_OUTPUT

          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            echo "dry_run=true" >> $GITHUB_OUTPUT
          else
            echo "dry_run=false" >> $GITHUB_OUTPUT
          fi

          # Check if there were errors
          if [ "${{ steps.apply.outputs.apply_status }}" -eq 0 ]; then
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "success=false" >> $GITHUB_OUTPUT
          fi

          # Extract operation counts from log
          CREATE_COUNT=$(grep -c "^\[CREATE\]\|^  âž• CREATE:" apply.log || echo "0")
          UPDATE_COUNT=$(grep -c "^\[UPDATE\]\|^  ðŸ“ UPDATE:" apply.log || echo "0")
          DELETE_COUNT=$(grep -c "^\[DELETE\]\|^  âŒ DELETE:" apply.log || echo "0")

          echo "create_count=$CREATE_COUNT" >> $GITHUB_OUTPUT
          echo "update_count=$UPDATE_COUNT" >> $GITHUB_OUTPUT
          echo "delete_count=$DELETE_COUNT" >> $GITHUB_OUTPUT

      - name: Upload results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: apply-risk-rules-${{ inputs.environment }}-${{ github.run_number }}
          path: |
            apply.log
            environments/${{ inputs.environment }}/config/risk_rules.json
          retention-days: 90

      - name: Post summary
        if: always()
        run: |
          echo "## Risk Rules Apply Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.results.outputs.dry_run }}" == "true" ]; then
            echo "**Mode:** ðŸ” Dry Run (no changes made)" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Mode:** âœ… Apply (changes executed)" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Delete Removed:** ${{ github.event.inputs.delete_removed }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Operations Performed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Operation | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| âž• Create | ${{ steps.results.outputs.create_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“ Update | ${{ steps.results.outputs.update_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| âŒ Delete | ${{ steps.results.outputs.delete_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Total Rules in Config** | **${{ steps.results.outputs.total }}** |" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.results.outputs.success }}" == "true" ]; then
            echo "**Status:** âœ… Completed successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status:** âŒ Completed with errors (see log below)" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Full Log" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat apply.log >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.results.outputs.dry_run }}" == "true" ]; then
            echo "**Next Step:** Re-run this workflow with dry_run=false to apply changes to Okta" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Next Step:** Verify risk rules in Okta Admin Console > Identity Governance > Governance" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "You can also run the import workflow to sync the latest state:" >> $GITHUB_STEP_SUMMARY
            echo '```bash' >> $GITHUB_STEP_SUMMARY
            echo "gh workflow run import-risk-rules.yml -f environment=${{ inputs.environment }} -f commit_changes=true" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
