name: Validate Label Mappings

on:
  pull_request:
    paths:
      - 'environments/*/config/label_mappings.json'
    types: [opened, synchronize, reopened]

jobs:
  validate-config:
    name: Validate Label Configuration
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install jsonschema

      - name: Find changed label mapping files
        id: changed-files
        run: |
          echo "files<<EOF" >> $GITHUB_OUTPUT
          git diff --name-only origin/${{ github.base_ref }}...${{ github.sha }} | grep 'label_mappings.json' >> $GITHUB_OUTPUT || true
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Validate JSON syntax and structure
        run: |
          echo "## Label Mappings Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          VALIDATION_PASSED=true

          for file in ${{ steps.changed-files.outputs.files }}; do
            echo "Validating: $file"
            echo "### üìÑ $file" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Check JSON syntax
            if python3 -m json.tool "$file" > /dev/null 2>&1; then
              echo "‚úÖ Valid JSON syntax" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ùå Invalid JSON syntax" >> $GITHUB_STEP_SUMMARY
              VALIDATION_PASSED=false
              continue
            fi

            # Check required fields and ORN format
            python3 scripts/validate_label_config.py "$file" >> $GITHUB_STEP_SUMMARY

            if [ $? -ne 0 ]; then
              VALIDATION_PASSED=false
            fi

            echo "" >> $GITHUB_STEP_SUMMARY
          done

          if [ "$VALIDATION_PASSED" = false ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "‚ùå **Validation failed** - Please fix the errors above" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "‚úÖ **All validations passed**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
            echo "1. Get PR approval" >> $GITHUB_STEP_SUMMARY
            echo "2. Merge PR to main" >> $GITHUB_STEP_SUMMARY
            echo "3. Label application workflow will run automatically in dry-run mode" >> $GITHUB_STEP_SUMMARY
            echo "4. Manually trigger workflow with \`dry_run=false\` to apply changes" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Comment on PR
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            // Read step summary
            let summary = "Configuration validation completed. See workflow summary for details.";

            const output = `## üè∑Ô∏è Label Mappings Validation

            Configuration file validation has completed for this PR.

            ${summary}

            ### GitOps Workflow
            When this PR is merged:
            1. ‚úÖ Configuration will be merged to main branch
            2. üîç Label application workflow will run automatically in **dry-run mode**
            3. üìä Dry-run results will be available in workflow summary
            4. üîê Manual approval required to apply labels (run workflow with \`dry_run=false\`)

            This ensures all label changes have:
            - ‚úì Code review (via PR)
            - ‚úì Automated validation (this workflow)
            - ‚úì Dry-run preview (automatic on merge)
            - ‚úì Manual approval (before applying)

            *Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}*
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });
